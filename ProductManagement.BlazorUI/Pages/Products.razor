@page "/products"
@attribute [Authorize]

@using System.Linq
@using ProductManagement.Application.Common.Models
@using ProductManagement.Application.Features.Product
@using ProductManagement.Application.Features.Product.DTOs

@inject ProductService ProductService
@inject NavigationManager Navigation

<h3 class="mb-4">Products</h3>

<div class="d-flex justify-content-between mb-3">
    <button class="btn btn-primary"
            @onclick="GoToCreate">
        + Add Product
    </button>

    <input class="form-control w-25"
           placeholder="Search..."
           value="@parameters.SearchTerm"
           @oninput="OnSearchChanged" />
</div>

@if (!string.IsNullOrEmpty(toastMessage))
{
    <div class="alert @(toastSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show">
        @toastMessage
        <button type="button" class="btn-close"
                @onclick="ClearToast"></button>
    </div>
}

@if (isLoading)
{
    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex
                    justify-content-center align-items-center"
         style="background: rgba(255,255,255,0.6); z-index: 1050;">
        <div class="d-flex flex-column align-items-center">
            <div class="spinner-border text-primary"
                 role="status">
            </div>
            <p class="mt-3 fw-semibold">Data Loading...</p>
        </div>
    </div>
}


@if (result == null)
{
    @if (isLoading)
    {
        <div class="position-fixed top-0 start-0 w-100 h-100 d-flex
                            justify-content-center align-items-center"
             style="background: rgba(255,255,255,0.6); z-index: 1050;">
            <div class="d-flex flex-column align-items-center">
                <div class="spinner-border text-primary"
                     role="status">
                </div>
                <p class="mt-3 fw-semibold">Data Loading...</p>
            </div>
        </div>
    }
}
else if (!result.Items.Any())
{
    <p>No products found.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>

                <th>
                    <button class="btn btn-link p-0"
                            @onclick='() => SortBy("Price")'>
                        Price
                        @(parameters.SortBy == "Price" ? (parameters.Descending ? " 🔽" : " 🔼") : "")
                    </button>
                </th>

                <th>Stock</th>
                <th>Category</th>
                <th>Active</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            @foreach (var product in result.Items)
            {
                <tr>
                    <td>@product.Name</td>
                    <td>@product.Price</td>
                    <td>@product.StockQuantity</td>
                    <td>@product.CategoryName</td>
                    <td>@(product.IsActive ? "Yes" : "No")</td>
                    <td>

                        <AuthorizeView Roles="Admin,Manager">
                            <Authorized>
                                <button class="btn btn-warning btn-sm me-2"
                                        @onclick="() => Edit(product.Id)">
                                    Edit
                                </button>
                            </Authorized>
                        </AuthorizeView>

                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <button class="btn btn-danger btn-sm"
                                        @onclick="() => ConfirmDelete(product.Id)">
                                    Delete
                                </button>
                            </Authorized>
                        </AuthorizeView>

                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Delete Confirmation -->
    @if (showDeleteModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Delete</h5>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this product?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary"
                                @onclick="CloseModal">
                            Cancel
                        </button>

                        <button class="btn btn-danger"
                                @onclick="DeleteConfirmed">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }


    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-3">

        <button class="btn btn-secondary me-2"
                disabled="@(parameters.PageNumber == 1)"
                @onclick="PreviousPage">
            Previous
        </button>

        <span class="align-self-center">
            Page @parameters.PageNumber
        </span>

        <button class="btn btn-secondary ms-2"
                disabled="@(parameters.PageNumber* parameters.PageSize >= result.TotalCount)"
                @onclick="NextPage">
            Next
        </button>

    </div>
}

@code {
    private PagedResult<ProductResponseDto>? result;

    private ProductQueryParameters parameters = new()
    {
        PageNumber = 1,
        PageSize = 5
    };
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        isLoading = true;
        result = await ProductService.GetPagedAsync(parameters);
        await Task.Delay(3000);
        isLoading = false;
    }

    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        parameters.SearchTerm = e.Value?.ToString();
        parameters.PageNumber = 1;
        await LoadProducts();
    }

    private void GoToCreate()
    {
        Navigation.NavigateTo("/create-product");
    }

    private void Edit(int id)
    {
        Navigation.NavigateTo($"/edit-product/{id}");
    }

    private async Task NextPage()
    {
        if (result != null &&
            parameters.PageNumber * parameters.PageSize < result.TotalCount)
        {
            parameters.PageNumber++;
            await LoadProducts();
        }
    }

    private async Task PreviousPage()
    {
        if (parameters.PageNumber > 1)
        {
            parameters.PageNumber--;
            await LoadProducts();
        }
    }

    private async Task SortBy(string column)
    {
        if (parameters.SortBy == column)
            parameters.Descending = !parameters.Descending;
        else
        {
            parameters.SortBy = column;
            parameters.Descending = false;
        }

        parameters.PageNumber = 1;
        await LoadProducts();
    }

    private bool showDeleteModal = false;
    private int productToDelete;

    private void ConfirmDelete(int id)
    {
        productToDelete = id;
        showDeleteModal = true;
    }

    private void CloseModal()
    {
        showDeleteModal = false;
    }

    private async Task DeleteConfirmed()
    {
        var success = await ProductService.DeleteAsync(productToDelete);

        showDeleteModal = false;

        if (success)
        {
            await LoadProducts();
            ShowToast("Product deleted successfully", true);
        }
        else
        {
            ShowToast("Failed to delete product", false);
        }
    }

    private string? toastMessage;
    private bool toastSuccess;

    private void ShowToast(string message, bool success)
    {
        toastMessage = message;
        toastSuccess = success;
    }

    private void ClearToast()
    {
        toastMessage = null;
    }

}

